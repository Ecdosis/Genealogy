## Genealogy

Genealogy is a tomcat websvice that can also be run as a Jetty service. It 
works on port 8080 (Tomcat) or on port 8096 (Jetty). Its goal is to manage 
a set of resources stored in Mongodb for representing a genealogy. 
Resources are of two types:

1. Persons. These contain birth and death information (and location of 
each) as well as the names of any people married in his/her lifetime.

2. Marriages. These include the names of the groom and bride, a list of 
ceremonies where and when they were married, and a list of children.

### docids
These resources are identified by their unique docids. When using the 
upload.sh script in the harpur-genealogy example the file name is taken as 
the docid for each resource, minus the ".json" extension. Marriages are 
identified by the groom's and bride's names written out in full, in 
lowercase with "_" instead of spaces. Persons are identified in the same 
way but using only the name of the person. The names specified in the 
"children" and "marriages" fields are converted into identifiers and so 
must match precisely the docids of the resources. If there is a name clash 
then "Jnr" or "Snr" or "{year}" or any string can be appended to the 
person's name. All persons must be unique when converted into identifiers.

A special docid is created automatically for the genealogy root at 
{short-id}/root, where {short-id} is the base docid passed to 
/genealogy/create. short-ids are limited to two components. i.e. 
english/conrad/nostromo will be shortened to english/conrad.

## Services

### Delete
A POST to http://localhost/genealogy/delete remove an entire genealogy.

There are two arguments:

1. docid: the simple docid of the genealogy to be removed 
in the database. 

2. userdata: this is a base64 encoded string containing a simple JSON 
credential encrypted using the hard-coded key and a simple XOR cipher:

> I tell a settlers tale of the old times

The JSON credential lists the user name and roles, one of which must be 
"editor". The encrypt commandline tool written in C is provided to concoct 
the credential for testing. Normally it will be generated by the client 
web tool and sent to the server. The user name must match that used to 
create the genealogy for the delete to be successful.
An example of the decrypted credential looks like this:

> {"name":"desmond","roles": ["editor"]}

This is basically the format returned by Drupal CMS but is fairly general.

### Create
A POST to /genealogy/create creates a new genealogy. 

The docid parameter will create a resource called {docid}/root. 

The userdata parameter is the same as that supplied for the delete service. 
However, since the resource does not yet exist the user need only be an 
editor. The user name is copied into the root resource, and after that only 
that user can remove it.

### Post to /genealogy/

A straight post to genealogy will add a new resource to the genealogy. The 
resource must follow the example formats in the harpur-genealogy. One 
resource may contain the isRoot field. This designates a marriage as the root 
of the entire tree. Its docid will be copied into {simple-id}/root, but the 
resource itself will be stored separately.

There are three required parameters:

1. docid: the unique docid of the resource. e.g. 
> english/harpur/john_milton_harpur

2. record: this contains the text of the JSON resourc. For examples see the 
harpur-genealogy sample.

3. userdata: as specified above under /genealogy/delete. The user must be 
an editor to post a modification to the tree.

### GET from /genealogy/

This builds the entire tree in an obvious JSON format, starting at the 
designated root. There is only one parameter:

1. docid: the simple docid for the entire tree, minus the suffix "/root"

## Future plans

As yet there is no online editor for Genealogy. Resources can be created 
using a standard text editor. However, there is a viewer, which converts 
the table into an expandable HTML list. It is in the ecdosis-front 
repository.
